<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR eNETS</title>
  <!-- style -->
  <link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet">
  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <div class="container">
    <div>
      <header>
        <h1>eNETS QR Responsive Demo</h1>
      </header>
      <div class="data-input">
        <table class="table table-condensed" align="center">
          <thead>
            <tr>
              <th>Fields</th>
              <th>Input</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><label>Amount (Cents) </label></td>
              <td><input class="form-control" type="text" size="40" id="amount" value="1000"></td>
            </tr>
            <tr>
              <td><label>STAN </label></td>
              <td><input class="form-control" type="text" size="40" id="STAN" value="100001"></td>
            </tr>
            <tr>
              <td><label>Host TID </label></td>
              <td><input class="form-control" type="text" id="TID" value="37066801"></td>
            </tr>
            <tr>
              <td><label>Host MID </label></td>
              <td><input class="form-control" type="text" id="MID" value="11137066800"></td>
            </tr>
            <tr>
              <td><label>API Key </label></td>
              <td><input class="form-control" type="text" id="apiKey" value="b027dacd-1c13-4916-8b93-38fae6be2f80"></td>
            </tr>
            <tr>
              <td><label>Secret Key </label></td>
              <td><input class="form-control" type="text" id="secretKey" value="21296dd3-5bf6-4dfc-b8a2-03fbcc213b7b"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="container container-result">
      <button class="button" align="center">Generate QR</button>
      <div id="payment_image"></div>
      <div id="result_image"></div>
    </div>


    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/sha256.js"></script>
    <script>
      $(document).ready(function() {
        $('button').click(function() {
          var continueFlag = true;
          var qrCode = '';
          var amount = $('#amount').val();
          var stan = $('#STAN').val();
          var tid = $('#TID').val();
          var mid = $('#MID').val();
          var apikey = $('#apiKey').val();
          var apiSecret = $('#secretKey').val();

          var data = JSON.stringify({"mti":"0200","process_code":"990000","amount":amount,"stan":stan,"transaction_time":"180647","transaction_date":"0313","entry_mode":"000","condition_code":"85","institution_code":"20000000001","host_tid":tid,"host_mid":mid,"npx_data":{"E103":tid,"E201":"00000123","E202":"SGD"},"communication_data":[{"type":"http","category":"URL","destination":"https://your-domain-name:8801/demo/order/notification","addon":{"external_API_keyID":"8bc63cde-2647-4a78-ac75-d5f534b56047"}}],"getQRCode":"Y"});


          var sign = btoa(sha256(data+apiSecret).match(/\w{2}/g).map(a => String.fromCharCode(parseInt(a, 16))).join(''));

          $.ajax({
            type: 'POST',
            url: 'https://uat-api.nets.com.sg:9065/uat/merchantservices/qr/dynamic/v1/order/request',
            async: false,
            process_data: 'false',
            headers: {
              'KeyId': apikey,
              'Sign': sign,
              'Content-Type': 'application/json'
            },
            data: data,

            dataType: 'text',
            success: function(result) {
              console.log(result);
              json_result = jQuery.parseJSON(result)
              qrCode = json_result.txn_identifier;
              $('#payment_image').html('<img class="hidden-xs" height="180" width="180" src="data:image/png;base64,' + json_result.qr_code + '" /> <a href="netspay://payment/?source=com.nets.netspay&amp;urlscheme=netspay&amp;qrdata=' + encodeURIComponent(qrCode) + '"> <img class="hidden-md hidden-lg height="180" width="180" " src="http://35.186.150.91/images/netspay.png" /></a>');
              // $('#netspay_image').html('<a href="netspay://payment/?source=com.nets.netspay&amp;urlscheme=netspay&amp;qrdata=' + encodeURIComponent(qrCode) + '"> <img class="hidden-md hidden-lg" src="http://35.186.150.91/images/netspay.png" /></a>');
              setTimeout(function() {
                query_function();
              }, 10000);

            },
            error: function(result) {
              var error_message = result.code;
              alert(error_message);
            }
          });
          var inquiryCount = 1;
          data2 = JSON.stringify({"mti":"0100","process_code":"330000","stan":stan,"transaction_time":"180647","transaction_date":"0313","entry_mode":"000","condition_code":"85","institution_code":"20000000001","host_tid":tid,"host_mid":mid,"npx_data":{"E103":tid,"E201":"00000123","E202":"SGD"},"txn_identifier":qrCode});
          sign = btoa(sha256(data2+apiSecret).match(/\w{2}/g).map(a => String.fromCharCode(parseInt(a, 16))).join(''));
          query_function = (function() {
            $.ajax({
              type: "POST",
              async: false,
              process_data: 'false',
              headers: {
                'KeyId': apikey,
                'Sign': sign,
                'Content-Type': 'application/json'
              },
              url: "https://uat-api.nets.com.sg:9065/uat/merchantservices/qr/dynamic/v1/transaction/query",
              data: data2,
              success: function(result) {
                console.log(result);
                if (result.response_code == '09' && inquiryCount < 20) {
                  setTimeout(function() {
                    query_function();
                  }, 2500);
                  inquiryCount++;
                } else {
                  $('#payment_image').hide();
                  if (result.response_code == '00') {
                    $('#result_image').html('<img src="https://www.svgrepo.com/show/13650/success.svg" alt="Transaction Successful" height="100" width="100"><h4>Payment Success!</h4>');
                  } else {
                    $('#result_image').html('<img src="https://www.svgrepo.com/show/13658/error.svg" alt="Transaction Failure" height="100" width="100"><h4>Payment Failure!</h4>');
                  }
                }
              },
              error: function(result) {
                alert('error');
              }
            });
          });
          $(this).hide();
        });
      });
    </script>
  </div>
</body>

</html>
